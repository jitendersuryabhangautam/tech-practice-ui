{
  "id": "secrets",
  "title": "Secrets",
  "description": "Store and manage sensitive information like passwords, tokens, and keys.",
  "code": "# secret.yaml\napiVersion: v1\nkind: Secret\nmetadata:\n  name: db-secret\ntype: Opaque\ndata:\n  username: YWRtaW4=  # base64 encoded\n  password: cGFzc3dvcmQxMjM=\n\n# stringData for plain text (auto-encoded)\nstringData:\n  api-key: \"my-secret-api-key\"",
  "command": "# Create Secret from literals\nkubectl create secret generic db-secret \\\n  --from-literal=username=admin \\\n  --from-literal=password=password123\n\n# Create Secret from files\nkubectl create secret generic tls-secret \\\n  --from-file=tls.crt=cert.pem \\\n  --from-file=tls.key=key.pem\n\n# Get Secrets\nkubectl get secrets\n\n# Describe Secret (values hidden)\nkubectl describe secret db-secret\n\n# View Secret data (base64 encoded)\nkubectl get secret db-secret -o yaml\n\n# Decode secret\nkubectl get secret db-secret -o jsonpath='{.data.password}' | base64 --decode\n\n# Delete Secret\nkubectl delete secret db-secret",
  "example": "# Use Secret as environment variables\napiVersion: v1\nkind: Pod\nmetadata:\n  name: myapp\nspec:\n  containers:\n  - name: app\n    image: myapp:latest\n    env:\n    - name: DB_USERNAME\n      valueFrom:\n        secretKeyRef:\n          name: db-secret\n          key: username\n    - name: DB_PASSWORD\n      valueFrom:\n        secretKeyRef:\n          name: db-secret\n          key: password\n\n# Mount Secret as volume\nvolumes:\n- name: secret-volume\n  secret:\n    secretName: db-secret\nvolumeMounts:\n- name: secret-volume\n  mountPath: /etc/secrets\n  readOnly: true",
  "useCase": "Credentials, API keys, TLS certificates, passwords, tokens",
  "interviewQuestions": [
    {
      "question": "Are Secrets encrypted in Kubernetes by default?",
      "answer": "No! Base64 encoded, NOT encrypted. Stored plain in etcd. Enable encryption at rest in apiserver --encryption-provider-config. Base64 is encoding (reversible), not encryption. Anyone with etcd access can decode."
    },
    {
      "question": "What are the Secret types and when to use each?",
      "answer": "Opaque: generic key-value (default). kubernetes.io/tls: TLS cert/key. kubernetes.io/dockerconfigjson: Docker registry auth. kubernetes.io/basic-auth: username/password. kubernetes.io/ssh-auth: SSH keys. kubernetes.io/service-account-token: SA tokens."
    },
    {
      "question": "Tricky: Can you view Secret data with kubectl describe?",
      "answer": "No! kubectl describe hides values for security. Use kubectl get secret mysecret -o yaml to see base64 data. Decode: echo <base64string> | base64 --decode. This prevents accidental exposure."
    },
    {
      "question": "Output: kubectl create secret generic test --from-literal=pass=admin123. How is 'admin123' stored?",
      "answer": "Base64 encoded as 'YWRtaW4xMjM=' in etcd. Not encrypted unless encryption at rest enabled. Anyone with get secret permission can decode it."
    },
    {
      "question": "What is stringData vs data in Secret YAML?",
      "answer": "stringData: plain text, auto-converted to base64. data: already base64 encoded. Use stringData for convenience (kubectl encodes it). stringData not stored – converted to data before storage. Read-only field."
    },
    {
      "question": "How do ImagePullSecrets work?",
      "answer": "Stores Docker registry credentials. Created with kubectl create secret docker-registry. Referenced in pod spec imagePullSecrets. Allows pulling from private registries. Type: kubernetes.io/dockerconfigjson."
    },
    {
      "question": "Tricky: Secret in namespace A, Pod in namespace B. Will it work?",
      "answer": "No! Like ConfigMap, Secret must be in same namespace as Pod. Cross-namespace not allowed. Duplicate secret in each namespace or use external secret management (Vault, cloud KMS)."
    },
    {
      "question": "What is the 1MB limit on Secrets and how to handle larger data?",
      "answer": "Secrets limited to 1MB (etcd constraint). For larger: use external secret stores (HashiCorp Vault, AWS Secrets Manager, Azure Key Vault). Or mount as volume from external source. Or split into multiple secrets."
    },
    {
      "question": "Predict: Secret mounted as volume. What are file permissions?",
      "answer": "0644 (rw-r--r--) by default. Can customize with defaultMode in volume spec. Example: 0400 (r--------) for read-only by owner. Secrets mounted read-only."
    },
    {
      "question": "What is an immutable Secret and security benefit?",
      "answer": "immutable: true prevents modification. Benefits: protection from accidents, better performance (no watches), defense against attackers modifying secrets. Must delete/recreate to change. Available from K8s v1.21."
    }
  ],
  "exercises": [
    {
      "type": "command",
      "question": "Create generic secret with username and password",
      "answer": "kubectl create secret generic creds --from-literal=username=admin --from-literal=password=secret123"
    },
    {
      "type": "output",
      "question": "Decode secret manually: data.password = 'cGFzc3dvcmQ='",
      "answer": "echo 'cGFzc3dvcmQ=' | base64 --decode → password"
    },
    {
      "type": "scenario",
      "question": "Create TLS secret from cert.pem and key.pem files",
      "answer": "kubectl create secret tls mytls --cert=cert.pem --key=key.pem"
    },
    {
      "type": "command",
      "question": "Create Docker registry secret for pulling private images",
      "answer": "kubectl create secret docker-registry regcred --docker-server=myregistry.io --docker-username=user --docker-password=pass"
    },
    {
      "type": "debug",
      "question": "Pod shows ImagePullBackOff for private image. What to check?",
      "answer": "1) imagePullSecrets referenced in pod spec 2) Secret exists: kubectl get secret 3) Credentials valid 4) Secret type is docker-registry 5) Secret in same namespace"
    },
    {
      "type": "tricky",
      "question": "Can you use kubectl edit to change Secret data?",
      "answer": "Yes, but values must be base64 encoded! Edit shows base64. Or use stringData patch. Or delete and recreate. kubectl edit shows encoded data."
    },
    {
      "type": "command",
      "question": "View decoded secret value for key 'apikey'",
      "answer": "kubectl get secret mysecret -o jsonpath='{.data.apikey}' | base64 --decode"
    },
    {
      "type": "scenario",
      "question": "Mount secret as volume in pod at /etc/secrets read-only",
      "answer": "Pod spec: volumes: [name: sec, secret: {secretName: mysec}], volumeMounts: [name: sec, mountPath: /etc/secrets, readOnly: true]"
    },
    {
      "type": "troubleshoot",
      "question": "Secret changed but pod uses old value (env var). Why?",
      "answer": "Env vars don't auto-update from Secrets. Must restart pod. Use volume mount for auto-update (60s delay) or kubectl rollout restart deployment."
    },
    {
      "type": "output",
      "question": "Create secret with stringData. What is stored in etcd?",
      "answer": "Converted to base64 and stored in data field. stringData is convenience field, not persisted."
    }
  ],
  "programExercises": [
    {
      "type": "program",
      "question": "Program 1: Create secret, use in pod as env vars, verify",
      "code": "kubectl create secret generic dbsecret --from-literal=user=admin --from-literal=pass=secret\\nkubectl run dbpod --image=postgres --restart=Never --dry-run=client -o yaml > db.yaml\\n# Edit to add env from secretKeyRef\\nkubectl apply -f db.yaml\\nkubectl exec dbpod -- env | grep -E 'user|pass'",
      "output": "user=admin\\npass=secret (environment variables)"
    },
    {
      "type": "program",
      "question": "Program 2: Mount secret as volume, verify file contents",
      "code": "kubectl create secret generic filesec --from-literal=token=abc123\\nkubectl run secpod --image=nginx --dry-run=client -o yaml > sec.yaml\\n# Edit to add secret volume mount at /secrets\\nkubectl apply -f sec.yaml\\nkubectl exec secpod -- cat /secrets/token",
      "output": "abc123"
    },
    {
      "type": "program",
      "question": "Program 3: Create TLS secret and verify type",
      "code": "openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj '/CN=test'\\nkubectl create secret tls testtls --cert=tls.crt --key=tls.key\\nkubectl get secret testtls -o jsonpath='{.type}'",
      "output": "kubernetes.io/tls"
    },
    {
      "type": "program",
      "question": "Program 4: Decode secret programmatically",
      "code": "kubectl create secret generic mysec --from-literal=password=mypass123\\nkubectl get secret mysec -o jsonpath='{.data.password}' | base64 --decode",
      "output": "mypass123"
    },
    {
      "type": "program",
      "question": "Program 5: Test ImagePullSecret for private registry",
      "code": "kubectl create secret docker-registry myreg --docker-server=docker.io --docker-username=user --docker-password=pass123\\nkubectl run private --image=user/privateimage:latest --dry-run=client -o yaml > priv.yaml\\n# Add imagePullSecrets: [{name: myreg}]\\nkubectl apply -f priv.yaml\\nkubectl describe pod private | grep 'pull image'",
      "output": "Uses myreg secret to authenticate and pull image"
    },
    {
      "type": "program",
      "question": "Program 6: Create immutable secret",
      "code": "kubectl create secret generic immsec --from-literal=key=value --dry-run=client -o yaml | sed '/metadata:/a\\  immutable: true' | kubectl apply -f -\\nkubectl patch secret immsec -p '{\\\"data\\\":{\\\"key\\\":\\\"bmV3dmFsdWU=\\\"}}'",
      "output": "Patch fails: field is immutable"
    },
    {
      "type": "program",
      "question": "Program 7: Compare Secret size limit - test 1MB boundary",
      "code": "dd if=/dev/zero bs=1M count=1 | base64 > largefile.txt\\nkubectl create secret generic large --from-file=largefile.txt",
      "output": "Error: Secret too large (exceeds 1MB etcd limit)"
    }
  ],
  "category": "Configuration & Storage"
}