{
  "id": "subqueries",
  "title": "Subqueries",
  "description": "Nested queries used within SELECT, FROM, WHERE, or HAVING clauses.",
  "code": "-- CANONICAL E-COMMERCE SCHEMA\nCREATE TABLE users (\n  id SERIAL PRIMARY KEY,\n  first_name VARCHAR(100) NOT NULL,\n  last_name VARCHAR(100) NOT NULL,\n  email VARCHAR(255) UNIQUE NOT NULL,\n  role VARCHAR(20) NOT NULL DEFAULT 'customer',\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE TABLE products (\n  id SERIAL PRIMARY KEY,\n  name VARCHAR(255) NOT NULL,\n  sku VARCHAR(100) UNIQUE NOT NULL,\n  price DECIMAL(10,2) NOT NULL,\n  stock_quantity INT NOT NULL DEFAULT 0,\n  category VARCHAR(100),\n  image_url TEXT,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE TABLE orders (\n  id SERIAL PRIMARY KEY,\n  order_number VARCHAR(50) UNIQUE NOT NULL,\n  user_id INT NOT NULL REFERENCES users(id),\n  total_amount DECIMAL(10,2) NOT NULL,\n  status VARCHAR(20) NOT NULL,\n  payment_method VARCHAR(20),\n  shipping_address JSONB,\n  billing_address JSONB,\n  created_at TIMESTAMP DEFAULT NOW(),\n  updated_at TIMESTAMP DEFAULT NOW()\n);\n\nCREATE TABLE order_items (\n  id SERIAL PRIMARY KEY,\n  order_id INT NOT NULL REFERENCES orders(id),\n  product_id INT NOT NULL REFERENCES products(id),\n  quantity INT NOT NULL,\n  price_at_time DECIMAL(10,2) NOT NULL\n);\n\nCREATE TABLE payments (\n  id SERIAL PRIMARY KEY,\n  order_id INT NOT NULL REFERENCES orders(id),\n  amount DECIMAL(10,2) NOT NULL,\n  payment_method VARCHAR(20) NOT NULL,\n  status VARCHAR(20) NOT NULL,\n  transaction_id VARCHAR(100),\n  created_at TIMESTAMP DEFAULT NOW()\n);\n\n-- Subquery in WHERE\nSELECT * FROM products \nWHERE price > (SELECT AVG(price) FROM products);\n\n-- Subquery in SELECT\nSELECT \n  name,\n  price,\n  (SELECT AVG(price) FROM products) as avg_price,\n  price - (SELECT AVG(price) FROM products) as diff\nFROM products;\n\n-- Subquery in FROM\nSELECT category, avg_price \nFROM (\n  SELECT category, AVG(price) as avg_price \n  FROM products \n  GROUP BY category\n) as category_averages \nWHERE avg_price > 100;\n\n-- EXISTS\nSELECT * FROM users \nWHERE EXISTS (\n  SELECT 1 FROM orders \n  WHERE orders.user_id = users.id\n);",
  "example": "-- IN with subquery\nSELECT * FROM products \nWHERE category_id IN (\n  SELECT id FROM categories WHERE active = true\n);\n\n-- NOT IN\nSELECT * FROM users \nWHERE id NOT IN (\n  SELECT DISTINCT user_id FROM orders\n);\n\n-- Correlated subquery\nSELECT \n  p.name,\n  p.price,\n  (SELECT COUNT(*) FROM reviews r WHERE r.product_id = p.id) as review_count\nFROM products p;",
  "useCase": "Complex filtering, derived tables, conditional logic, data validation",
  "category": "Joins & Relationships"
}
