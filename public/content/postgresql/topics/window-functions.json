{
  "id": "window-functions",
  "title": "Window Functions (Advanced)",
  "description": "Perform calculations across rows related to the current row using RANK, ROW_NUMBER, and aggregate window functions.",
  "code": "-- Rank users by total spending\nSELECT \n  u.id, \n  u.name, \n  SUM(o.total_amount) AS total_spent,\n  RANK() OVER (ORDER BY SUM(o.total_amount) DESC) AS spending_rank\nFROM users u\nJOIN orders o ON o.user_id = u.id\nWHERE o.status = 'completed'\nGROUP BY u.id, u.name;\n\n-- Running total revenue by date\nSELECT \n  DATE(created_at) AS order_date,\n  SUM(total_amount) AS daily_revenue,\n  SUM(SUM(total_amount)) OVER (ORDER BY DATE(created_at)) AS running_total\nFROM orders\nWHERE status = 'completed'\nGROUP BY DATE(created_at);\n\n-- Dense rank products by revenue\nWITH product_revenue AS (\n  SELECT \n    oi.product_id,\n    SUM(oi.quantity * oi.price) AS revenue\n  FROM order_items oi\n  JOIN orders o ON o.id = oi.order_id\n  WHERE o.status = 'completed'\n  GROUP BY oi.product_id\n)\nSELECT \n  p.name,\n  pr.revenue,\n  DENSE_RANK() OVER (ORDER BY pr.revenue DESC) AS rank\nFROM product_revenue pr\nJOIN products p ON p.id = pr.product_id;",
  "example": "-- Find second highest spending user\nWITH ranked_users AS (\n  SELECT \n    u.*,\n    SUM(o.total_amount) AS total_spent,\n    RANK() OVER (ORDER BY SUM(o.total_amount) DESC) AS rank\n  FROM users u\n  JOIN orders o ON o.user_id = u.id\n  WHERE o.status = 'completed'\n  GROUP BY u.id\n)\nSELECT * FROM ranked_users WHERE rank = 2;\n\n-- Row number for orders per user\nSELECT \n  user_id,\n  order_number,\n  total_amount,\n  ROW_NUMBER() OVER (PARTITION BY user_id ORDER BY created_at) AS order_sequence\nFROM orders;\n\n-- Moving average revenue (7 days)\nSELECT \n  DATE(created_at) AS order_date,\n  SUM(total_amount) AS daily_revenue,\n  AVG(SUM(total_amount)) OVER (\n    ORDER BY DATE(created_at) \n    ROWS BETWEEN 6 PRECEDING AND CURRENT ROW\n  ) AS moving_avg_7day\nFROM orders\nWHERE status = 'completed'\nGROUP BY DATE(created_at);\n\n-- Cumulative order count\nSELECT \n  DATE(created_at) AS order_date,\n  COUNT(*) AS daily_orders,\n  SUM(COUNT(*)) OVER (ORDER BY DATE(created_at)) AS cumulative_orders\nFROM orders\nGROUP BY DATE(created_at);\n\n-- Partition by user and rank orders\nSELECT \n  user_id,\n  order_number,\n  total_amount,\n  RANK() OVER (PARTITION BY user_id ORDER BY total_amount DESC) AS amount_rank\nFROM orders;",
  "useCase": "Ranking, running totals, moving averages, analytics, time-series analysis, leaderboards",
  "category": "Advanced Queries"
}
