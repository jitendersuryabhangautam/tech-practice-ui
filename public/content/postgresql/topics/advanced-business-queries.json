{
  "id": "advanced-business-queries",
  "title": "Advanced Real Business Queries",
  "description": "Real-world business analytics queries for revenue reporting, customer insights, conversion metrics, and KPIs.",
  "code": "-- Monthly revenue report\nSELECT \n  DATE_TRUNC('month', created_at) AS month,\n  COUNT(*) AS total_orders,\n  SUM(total_amount) AS total_revenue,\n  AVG(total_amount) AS avg_order_value\nFROM orders\nWHERE status = 'completed'\nGROUP BY DATE_TRUNC('month', created_at)\nORDER BY month DESC;\n\n-- Top 5 customers of all time\nSELECT \n  u.id,\n  u.name,\n  u.email,\n  COUNT(o.id) AS order_count,\n  SUM(o.total_amount) AS lifetime_value\nFROM users u\nJOIN orders o ON o.user_id = u.id\nWHERE o.status = 'completed'\nGROUP BY u.id, u.name, u.email\nORDER BY lifetime_value DESC\nLIMIT 5;\n\n-- Daily sales breakdown\nSELECT \n  DATE(created_at) AS sale_date,\n  COUNT(*) AS orders,\n  SUM(total_amount) AS revenue,\n  AVG(total_amount) AS avg_order\nFROM orders\nWHERE status = 'completed'\n  AND created_at >= CURRENT_DATE - INTERVAL '30 days'\nGROUP BY DATE(created_at)\nORDER BY sale_date DESC;",
  "example": "-- Conversion rate (cart â†’ order)\nWITH cart_users AS (\n  SELECT DISTINCT user_id FROM carts\n),\norder_users AS (\n  SELECT DISTINCT user_id FROM orders\n)\nSELECT \n  COUNT(DISTINCT cu.user_id) AS users_with_carts,\n  COUNT(DISTINCT ou.user_id) AS users_with_orders,\n  ROUND(\n    COUNT(DISTINCT ou.user_id)::DECIMAL / \n    NULLIF(COUNT(DISTINCT cu.user_id), 0) * 100, 2\n  ) AS conversion_rate_percent\nFROM cart_users cu\nLEFT JOIN order_users ou ON ou.user_id = cu.user_id;\n\n-- Average delivery time\nSELECT \n  AVG(EXTRACT(EPOCH FROM (delivered_at - created_at))/86400) AS avg_delivery_days\nFROM orders\nWHERE status = 'delivered' AND delivered_at IS NOT NULL;\n\n-- Return percentage\nSELECT \n  COUNT(DISTINCT o.id) AS total_completed_orders,\n  COUNT(DISTINCT r.order_id) AS returned_orders,\n  ROUND(\n    COUNT(DISTINCT r.order_id)::DECIMAL / \n    NULLIF(COUNT(DISTINCT o.id), 0) * 100, 2\n  ) AS return_rate_percent\nFROM orders o\nLEFT JOIN returns r ON r.order_id = o.id\nWHERE o.status = 'completed';\n\n-- Most refunded product\nSELECT \n  p.id,\n  p.name,\n  p.sku,\n  COUNT(r.id) AS return_count,\n  SUM(r.refund_amount) AS total_refunds\nFROM products p\nJOIN order_items oi ON oi.product_id = p.id\nJOIN returns r ON r.order_id = oi.order_id\nGROUP BY p.id, p.name, p.sku\nORDER BY return_count DESC\nLIMIT 1;\n\n-- Stock turnover rate\nWITH sold_quantities AS (\n  SELECT \n    product_id,\n    SUM(quantity) AS total_sold\n  FROM order_items oi\n  JOIN orders o ON o.id = oi.order_id\n  WHERE o.status = 'completed'\n    AND o.created_at >= NOW() - INTERVAL '30 days'\n  GROUP BY product_id\n)\nSELECT \n  p.id,\n  p.name,\n  p.stock_quantity AS current_stock,\n  COALESCE(sq.total_sold, 0) AS sold_last_30_days,\n  ROUND(\n    COALESCE(sq.total_sold, 0)::DECIMAL / \n    NULLIF(p.stock_quantity, 0), 2\n  ) AS turnover_ratio\nFROM products p\nLEFT JOIN sold_quantities sq ON sq.product_id = p.id\nORDER BY turnover_ratio DESC;\n\n-- Revenue by category\nSELECT \n  p.category,\n  COUNT(DISTINCT o.id) AS order_count,\n  SUM(oi.quantity * oi.price) AS category_revenue\nFROM products p\nJOIN order_items oi ON oi.product_id = p.id\nJOIN orders o ON o.id = oi.order_id\nWHERE o.status = 'completed'\nGROUP BY p.category\nORDER BY category_revenue DESC;\n\n-- Revenue by payment method\nSELECT \n  payment_method,\n  COUNT(*) AS order_count,\n  SUM(total_amount) AS total_revenue,\n  ROUND(AVG(total_amount), 2) AS avg_order_value\nFROM orders\nWHERE status = 'completed'\nGROUP BY payment_method\nORDER BY total_revenue DESC;\n\n-- Active users in last 30 days\nSELECT COUNT(DISTINCT user_id) AS active_users\nFROM (\n  SELECT user_id FROM orders WHERE created_at >= NOW() - INTERVAL '30 days'\n  UNION\n  SELECT user_id FROM carts WHERE updated_at >= NOW() - INTERVAL '30 days'\n) active;\n\n-- Cart abandonment list\nSELECT \n  u.id,\n  u.name,\n  u.email,\n  c.created_at AS cart_created,\n  COUNT(ci.id) AS items_in_cart,\n  SUM(ci.quantity * p.price) AS cart_value\nFROM users u\nJOIN carts c ON c.user_id = u.id\nJOIN cart_items ci ON ci.cart_id = c.id\nJOIN products p ON p.id = ci.product_id\nLEFT JOIN orders o ON o.user_id = u.id \n  AND o.created_at > c.created_at\nWHERE o.id IS NULL\n  AND c.created_at >= NOW() - INTERVAL '7 days'\nGROUP BY u.id, u.name, u.email, c.created_at\nHAVING SUM(ci.quantity * p.price) > 50\nORDER BY cart_value DESC;",
  "useCase": "Business analytics, KPIs, revenue reporting, customer insights, conversion tracking, performance metrics",
  "category": "Business Analytics"
}
