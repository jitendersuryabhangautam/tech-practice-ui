{
  "id": "subqueries-cte",
  "title": "Subqueries & CTE (Common Table Expressions)",
  "description": "Write complex queries using subqueries and CTEs for better readability and advanced filtering.",
  "code": "-- Get products with price greater than average price\nSELECT * FROM products \nWHERE price > (SELECT AVG(price) FROM products);\n\n-- Get users whose total order amount > 1000\nSELECT u.* \nFROM users u\nWHERE (\n  SELECT SUM(total_amount) \n  FROM orders \n  WHERE user_id = u.id AND status = 'completed'\n) > 1000;\n\n-- Get products with stock less than average stock\nSELECT * FROM products \nWHERE stock_quantity < (\n  SELECT AVG(stock_quantity) FROM products\n);\n\n-- Get latest order per user\nSELECT o.* \nFROM orders o\nWHERE o.created_at = (\n  SELECT MAX(created_at) \n  FROM orders \n  WHERE user_id = o.user_id\n);",
  "example": "-- Get users with highest spending\nSELECT u.*, total_spent \nFROM users u\nJOIN (\n  SELECT user_id, SUM(total_amount) AS total_spent \n  FROM orders \n  WHERE status = 'completed' \n  GROUP BY user_id\n) spending ON spending.user_id = u.id\nORDER BY total_spent DESC\nLIMIT 10;\n\n-- Get product with highest revenue\nSELECT p.*, revenue \nFROM products p\nJOIN (\n  SELECT oi.product_id, SUM(oi.quantity * oi.price) AS revenue \n  FROM order_items oi\n  JOIN orders o ON o.id = oi.order_id\n  WHERE o.status = 'completed'\n  GROUP BY oi.product_id\n) rev ON rev.product_id = p.id\nORDER BY revenue DESC\nLIMIT 1;\n\n-- Use CTE to calculate monthly revenue\nWITH monthly_revenue AS (\n  SELECT \n    DATE_TRUNC('month', created_at) AS month,\n    SUM(total_amount) AS revenue\n  FROM orders\n  WHERE status = 'completed'\n  GROUP BY DATE_TRUNC('month', created_at)\n)\nSELECT * FROM monthly_revenue ORDER BY month DESC;\n\n-- Use CTE to get user lifetime value\nWITH user_ltv AS (\n  SELECT \n    user_id,\n    COUNT(*) AS order_count,\n    SUM(total_amount) AS lifetime_value,\n    AVG(total_amount) AS avg_order_value\n  FROM orders\n  WHERE status = 'completed'\n  GROUP BY user_id\n)\nSELECT u.*, ltv.* \nFROM users u\nJOIN user_ltv ltv ON ltv.user_id = u.id\nORDER BY lifetime_value DESC;\n\n-- Get orders above global average order value\nWITH avg_order AS (\n  SELECT AVG(total_amount) AS avg_value FROM orders\n)\nSELECT o.* \nFROM orders o, avg_order\nWHERE o.total_amount > avg_order.avg_value;\n\n-- Get products ordered more than 5 times\nSELECT p.* \nFROM products p\nWHERE (\n  SELECT COUNT(DISTINCT order_id) \n  FROM order_items \n  WHERE product_id = p.id\n) > 5;\n\n-- Get users who requested returns more than once\nSELECT u.* \nFROM users u\nWHERE (\n  SELECT COUNT(*) \n  FROM returns r\n  JOIN orders o ON o.id = r.order_id\n  WHERE o.user_id = u.id\n) > 1;",
  "useCase": "Complex filtering, comparative analysis, business metrics, multi-step calculations",
  "category": "Advanced Queries"
}
