{
  "id": "transactions-concurrency",
  "title": "Transactions & Concurrency",
  "description": "Ensure data integrity with transactions, handle race conditions, and prevent overselling using locks.",
  "code": "-- Deduct stock safely during checkout\nBEGIN;\n  UPDATE products \n  SET stock_quantity = stock_quantity - 2 \n  WHERE id = 101 AND stock_quantity >= 2;\n  \n  INSERT INTO order_items (order_id, product_id, quantity, price)\n  VALUES (1001, 101, 2, 99.99);\nCOMMIT;\n\n-- Reserve stock using transaction\nBEGIN;\n  -- Check available stock\n  SELECT stock_quantity FROM products \n  WHERE id = 101 FOR UPDATE;\n  \n  -- Reserve if available\n  INSERT INTO stock_reservations (product_id, quantity, expires_at)\n  VALUES (101, 3, NOW() + INTERVAL '10 minutes');\n  \n  UPDATE products \n  SET stock_quantity = stock_quantity - 3 \n  WHERE id = 101;\nCOMMIT;",
  "example": "-- Cancel order and restore stock\nBEGIN;\n  -- Get order items\n  UPDATE products p\n  SET stock_quantity = stock_quantity + oi.quantity\n  FROM order_items oi\n  WHERE oi.order_id = 1001 AND oi.product_id = p.id;\n  \n  -- Update order status\n  UPDATE orders SET status = 'cancelled' WHERE id = 1001;\nCOMMIT;\n\n-- Handle payment failure rollback\nBEGIN;\n  UPDATE orders SET status = 'processing' WHERE id = 1001;\n  \n  INSERT INTO payments (order_id, amount, status)\n  VALUES (1001, 199.99, 'processing');\n  \n  -- Simulate payment failure\n  -- ROLLBACK; -- Will undo all changes\nCOMMIT;\n\n-- Prevent overselling using FOR UPDATE\nBEGIN;\n  -- Lock the row to prevent concurrent updates\n  SELECT stock_quantity FROM products \n  WHERE id = 101 FOR UPDATE;\n  \n  -- Verify stock is available\n  UPDATE products \n  SET stock_quantity = stock_quantity - 5 \n  WHERE id = 101 AND stock_quantity >= 5;\n  \n  -- Check if update succeeded\n  -- If 0 rows affected, stock was insufficient\nCOMMIT;\n\n-- Delete expired stock reservations\nBEGIN;\n  -- Get expired reservations\n  WITH expired AS (\n    DELETE FROM stock_reservations \n    WHERE expires_at < NOW() \n    RETURNING product_id, quantity\n  )\n  -- Restore stock\n  UPDATE products p\n  SET stock_quantity = stock_quantity + exp.quantity\n  FROM expired exp\n  WHERE p.id = exp.product_id;\nCOMMIT;\n\n-- Serializable transaction for critical operations\nBEGIN TRANSACTION ISOLATION LEVEL SERIALIZABLE;\n  -- Critical business logic here\n  UPDATE accounts SET balance = balance - 100 WHERE id = 1;\n  UPDATE accounts SET balance = balance + 100 WHERE id = 2;\nCOMMIT;",
  "useCase": "Data integrity, race conditions, stock management, payment processing, critical operations",
  "category": "Advanced Features"
}
