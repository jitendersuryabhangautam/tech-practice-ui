import { mkdirSync, readFileSync, writeFileSync } from "fs";
import { join } from "path";

const inputPath = join(process.cwd(), "data", "content-db.json");
const outputDir = join(process.cwd(), "docker", "postgres", "init");
const outputPath = join(outputDir, "02_seed_content.sql");

function sqlString(value) {
  if (value === undefined || value === null) return "''";
  return `'${String(value).replace(/'/g, "''")}'`;
}

function sqlJson(value) {
  return `${sqlString(JSON.stringify(value ?? null))}::jsonb`;
}

function safeArray(value) {
  return Array.isArray(value) ? value : [];
}

function main() {
  const db = JSON.parse(readFileSync(inputPath, "utf-8"));
  const technologies = safeArray(db.technologies);

  const lines = [];
  lines.push("-- Auto-generated by scripts/generate-postgres-seed-sql.mjs");
  lines.push("BEGIN;");
  lines.push("TRUNCATE TABLE admin_audit_logs, admin_publish_events, admin_content_reviews, program_exercises, exercises, interview_questions, quiz_questions, topics, technologies RESTART IDENTITY CASCADE;");

  for (const tech of technologies) {
    lines.push(
      `INSERT INTO technologies (slug, title, description) VALUES (${sqlString(
        tech.slug
      )}, ${sqlString(tech.meta?.title || tech.slug)}, ${sqlString(
        tech.meta?.description || ""
      )});`
    );
  }

  for (const tech of technologies) {
    const topics = safeArray(tech.topics);
    for (const topic of topics) {
      lines.push(
        `WITH t AS (SELECT id AS technology_id FROM technologies WHERE slug = ${sqlString(
          tech.slug
        )})
INSERT INTO topics (technology_id, topic_key, title, category, description, explanation, code, example, use_case, raw_json)
SELECT technology_id, ${sqlString(topic.id)}, ${sqlString(topic.title)}, ${sqlString(
          topic.category || "General"
        )}, ${sqlString(topic.description || "")}, ${sqlString(
          topic.explanation || ""
        )}, ${sqlString(topic.code || "")}, ${sqlString(topic.example || "")}, ${sqlString(
          topic.useCase || ""
        )}, ${sqlJson(topic)}
FROM t;`
      );

      safeArray(topic.interviewQuestions).forEach((item, idx) => {
        lines.push(
          `WITH tp AS (
  SELECT topics.id AS topic_id
  FROM topics
  JOIN technologies t ON t.id = topics.technology_id
  WHERE t.slug = ${sqlString(tech.slug)} AND topics.topic_key = ${sqlString(topic.id)}
)
INSERT INTO interview_questions (topic_id, sort_order, question, answer)
SELECT topic_id, ${idx + 1}, ${sqlString(item.question || "")}, ${sqlString(
            item.answer || ""
          )} FROM tp;`
        );
      });

      safeArray(topic.exercises).forEach((item, idx) => {
        lines.push(
          `WITH tp AS (
  SELECT topics.id AS topic_id
  FROM topics
  JOIN technologies t ON t.id = topics.technology_id
  WHERE t.slug = ${sqlString(tech.slug)} AND topics.topic_key = ${sqlString(topic.id)}
)
INSERT INTO exercises (topic_id, sort_order, exercise_type, question, answer)
SELECT topic_id, ${idx + 1}, ${sqlString(item.type || "general")}, ${sqlString(
            item.question || ""
          )}, ${sqlString(item.answer || "")} FROM tp;`
        );
      });

      safeArray(topic.programExercises).forEach((item, idx) => {
        lines.push(
          `WITH tp AS (
  SELECT topics.id AS topic_id
  FROM topics
  JOIN technologies t ON t.id = topics.technology_id
  WHERE t.slug = ${sqlString(tech.slug)} AND topics.topic_key = ${sqlString(topic.id)}
)
INSERT INTO program_exercises (topic_id, sort_order, question, code, output)
SELECT topic_id, ${idx + 1}, ${sqlString(item.question || "")}, ${sqlString(
            item.code || ""
          )}, ${sqlString(item.output || "")} FROM tp;`
        );
      });
    }

    safeArray(tech.quiz).forEach((item, idx) => {
      lines.push(
        `WITH t AS (SELECT id AS technology_id FROM technologies WHERE slug = ${sqlString(
          tech.slug
        )})
INSERT INTO quiz_questions (technology_id, sort_order, question, options, correct_answer, explanation)
SELECT technology_id, ${idx + 1}, ${sqlString(item.question || "")}, ${sqlJson(
          item.options || []
        )}, ${Number.isInteger(item.correctAnswer) ? item.correctAnswer : 0}, ${sqlString(
          item.explanation || ""
        )} FROM t;`
      );
    });
  }

  lines.push("COMMIT;");
  lines.push("");

  mkdirSync(outputDir, { recursive: true });
  writeFileSync(outputPath, lines.join("\n"), "utf-8");
  console.log(`Seed SQL generated: ${outputPath}`);
}

main();
